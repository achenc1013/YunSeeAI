# 🔒 安全运维模块完整文档

## 📋 概述

**版本**: YunSeeAI v2.0.0  
**日期**: 2025-11-04  
**新功能**: 智能安全运维与自动防护

---

## 🎯 功能介绍

安全运维模块是YunSeeAI的核心防护功能，实现了：

### 1. 智能系统识别 🖥️
- ✅ 自动识别Windows/Linux系统
- ✅ 识别Linux发行版（Ubuntu、CentOS、Debian、RedHat）
- ✅ 适配不同系统的安全检查

### 2. 配置安全审计 🔍
- ✅ SSH配置检查（密码登录、Root登录、端口）
- ✅ 防火墙状态检测（UFW、firewalld、Windows Firewall）
- ✅ RDP远程桌面配置检查
- ✅ 自动生成修复建议

### 3. 日志分析与攻击检测 🚨
- ✅ SSH暴力破解检测
- ✅ FTP登录攻击识别
- ✅ SMB/Samba攻击监控
- ✅ Windows事件日志分析
- ✅ 智能识别可疑IP

### 4. 自动封禁系统 🛡️
- ✅ 基于失败次数自动封禁
- ✅ 支持UFW、iptables、Windows Firewall
- ✅ 跳过内网IP
- ✅ 记录封禁详情

---

## 💡 使用方式

### 自然语言查询

系统支持多种自然语言表达：

#### 中文查询
```
✅ "检查系统安全"
✅ "安全审计"
✅ "有没有攻击？"
✅ "检测暴力破解"
✅ "分析系统日志"
✅ "检查服务器配置"
✅ "是否有入侵？"
✅ "系统安全吗？"
✅ "封禁攻击IP"
```

#### English Queries
```
✅ "Security audit"
✅ "Check system security"
✅ "Any attacks?"
✅ "Analyze logs"
✅ "Check configurations"
✅ "Is my system secure?"
```

### 命令行使用

```bash
# 启动YunSeeAI
npm start

# 进行安全审计
You: 检查系统安全
```

---

## 📊 输出示例

### Windows系统审计结果

```
🔒 系统安全审计报告

系统类型: Windows (Windows)
扫描时间: 2025-11-04 15:29:00

⚠️  配置安全问题 (1):

  🟡 中危 (1):
     • Remote Desktop: Remote Desktop is enabled
       建议: Ensure RDP is secured with strong passwords and network-level authentication

💡 安全建议:

  • Found 1 medium-severity issue(s). Should be addressed soon.

🤖 YunSeeAI 分析:
系统安全审计完成。发现0个高危配置问题，未检测到活跃攻击。
```

### Linux系统审计结果（含攻击）

```
🔒 系统安全审计报告

系统类型: Ubuntu (Linux)
扫描时间: 2025-11-04 10:15:32

⚠️  配置安全问题 (3):

  🔴 高危 (2):
     • SSH: Root login via SSH is permitted
       建议: Set 'PermitRootLogin no' or 'PermitRootLogin prohibit-password'
     • Firewall: UFW firewall is inactive
       建议: Enable firewall with 'sudo ufw enable'

  🟡 中危 (1):
     • SSH: Password authentication is enabled
       建议: Set 'PasswordAuthentication no' and use key-based authentication

🚨 攻击检测:

  📊 SSH暴力破解尝试:
     总失败次数: 150
     可疑IP (3):
       🔴 203.0.113.45 - 85次失败
       🔴 198.51.100.23 - 42次失败
       🟡 192.0.2.100 - 23次失败

✅ 自动封禁 (2个IP):

  🛡️  203.0.113.45
     失败次数: 85
     封禁方式: UFW
     时间: 2025-11-04 10:15:32

  🛡️  198.51.100.23
     失败次数: 42
     封禁方式: UFW
     时间: 2025-11-04 10:15:32

💡 安全建议:

  • Found 2 high-severity configuration issue(s). Immediate action required.
  • Automatically banned 2 suspicious IP(s) due to brute force attacks.

🤖 YunSeeAI 分析:
系统安全审计完成。发现2个高危配置问题，自动封禁了2个攻击IP。
建议立即修复SSH配置并启用防火墙以增强安全性。
```

---

## 🔧 技术实现

### 1. Python安全审计引擎

**文件**: `scanner/security_audit.py`

**核心类**: `SecurityAuditor`

**主要方法**:
- `audit_all()` - 执行完整审计
- `_detect_os()` - 检测操作系统
- `_check_configurations()` - 检查配置
- `_analyze_logs()` - 分析日志
- `_ban_suspicious_ips()` - 封禁IP

### 2. 系统识别

```python
def _detect_os(self) -> str:
    """Detect operating system type"""
    system = platform.system().lower()
    
    if system == "windows":
        return "Windows"
    elif system == "linux":
        # Detect Linux distribution
        try:
            with open('/etc/os-release', 'r') as f:
                content = f.read().lower()
                if 'ubuntu' in content:
                    return "Ubuntu"
                elif 'centos' in content:
                    return "CentOS"
                # ... 更多发行版
        except:
            return "Linux"
```

### 3. SSH配置检查

```python
def _check_linux_configs(self):
    """Check Linux system configurations"""
    ssh_config_path = "/etc/ssh/sshd_config"
    if os.path.exists(ssh_config_path):
        with open(ssh_config_path, 'r') as f:
            ssh_content = f.read()
            
            # Check PasswordAuthentication
            if re.search(r'^\s*PasswordAuthentication\s+yes', ssh_content, re.MULTILINE):
                self.results["config_issues"].append({
                    "severity": "medium",
                    "service": "SSH",
                    "issue": "Password authentication is enabled",
                    "recommendation": "Set 'PasswordAuthentication no'"
                })
```

### 4. 日志分析

```python
def _analyze_ssh_log(self, log_path: str) -> List[Dict]:
    """Parse SSH authentication failures"""
    failed_attempts = []
    
    with open(log_path, 'r') as f:
        lines = f.readlines()[-10000:]  # Recent 10000 lines
        
        for line in lines:
            if 'Failed password' in line:
                # Extract IP address
                ip_match = re.search(r'(\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3})', line)
                if ip_match:
                    failed_attempts.append({
                        "ip": ip_match.group(1),
                        "timestamp": ...,
                        "log_line": line.strip()
                    })
    
    return failed_attempts
```

### 5. IP封禁

```python
def _ban_suspicious_ips(self, suspicious_ips: List[Dict]):
    """Ban suspicious IPs using system firewall"""
    for ip_info in suspicious_ips:
        ip = ip_info["ip"]
        
        # Skip private IPs
        if ip.startswith(('127.', '192.168.', '10.', '172.')):
            continue
        
        # Try UFW
        result = subprocess.run(
            ['sudo', 'ufw', 'deny', 'from', ip],
            capture_output=True, text=True, timeout=5
        )
        
        if result.returncode == 0:
            self.results["banned_ips"].append({
                "ip": ip,
                "method": "UFW",
                "timestamp": datetime.now().isoformat()
            })
```

---

## 📁 文件结构

```
scanner/
├── security_audit.py          # 安全审计Python引擎
├── scanner-client.js          # Node.js客户端（含performSecurityAudit）
├── tools-registry.js          # 工具注册（含security_audit工具）
├── semantic-intent-parser.js  # 语义识别（含security_audit模式）
└── 安全运维模块完整文档.md   # 本文档

src/cli/
└── CommandHandler.ts          # CLI显示逻辑（含security_audit显示）
```

---

## 🎯 检测项目清单

### Linux配置检查

| 检查项 | 严重级别 | 说明 |
|--------|---------|------|
| SSH密码登录 | 中危 | 应禁用密码登录，使用密钥认证 |
| SSH Root登录 | 高危 | 应禁止root直接登录 |
| SSH默认端口 | 低危 | 建议更改为非标准端口 |
| UFW防火墙状态 | 高危 | 应启用并配置规则 |
| firewalld状态 | 高危 | CentOS/RedHat应启用 |

### Windows配置检查

| 检查项 | 严重级别 | 说明 |
|--------|---------|------|
| Windows防火墙 | 高危 | 应启用所有配置文件 |
| RDP远程桌面 | 中危 | 应确保强密码和NLA |

### 日志分析

| 日志类型 | 检测内容 | 阈值 |
|---------|---------|------|
| SSH (auth.log/secure) | 失败登录 | 5次/IP |
| FTP (vsftpd.log) | 失败登录 | 统计 |
| SMB (log.smbd) | 认证失败 | 统计 |
| Windows Security | Event ID 4625 | 统计 |

---

## 🧪 测试验证

### 测试1: 直接运行Python脚本

```bash
python scanner/security_audit.py
```

**预期输出**: JSON格式的审计结果

### 测试2: 通过CLI使用

```bash
npm start
```

```
You: 检查系统安全
```

**预期输出**: 格式化的审计报告 + AI分析

### 测试3: 测试语义识别

```bash
cd scanner
node test-security-audit.js
```

---

## ⚠️ 权限要求

### Linux系统

- **读取配置**: 需要读取 `/etc/ssh/sshd_config`
- **读取日志**: 需要读取 `/var/log/auth.log` 或 `/var/log/secure`
- **封禁IP**: 需要 `sudo` 权限执行 `ufw` 或 `iptables`

```bash
# 以root或sudo运行
sudo npm start
```

### Windows系统

- **读取注册表**: 需要管理员权限
- **读取事件日志**: 需要管理员权限
- **配置防火墙**: 需要管理员权限

```powershell
# 以管理员身份运行PowerShell
npm start
```

---

## 💡 使用场景

### 场景1: 新服务器上线前检查

```
用户: "检查系统安全"

AI: 
🔒 系统安全审计报告
发现3个配置问题：
- SSH允许Root登录（高危）
- 防火墙未启用（高危）  
- SSH使用默认端口（低危）

建议：立即修复高危问题后再上线。
```

### 场景2: 检测SSH暴力破解

```
用户: "有没有攻击？"

AI:
🚨 攻击检测：
SSH暴力破解尝试：150次
检测到3个可疑IP

已自动封禁2个攻击IP：
- 203.0.113.45 (85次失败)
- 198.51.100.23 (42次失败)

建议：修改SSH端口并禁用密码登录。
```

### 场景3: 定期安全检查

```
# 设置定时任务
crontab -e

# 每天凌晨2点执行安全审计
0 2 * * * python /path/to/security_audit.py >> /var/log/security_audit.log
```

---

## 🔄 工作流程

```
用户输入
   ↓
语义识别 → 检测为security_audit
   ↓
调用Python脚本
   ↓
系统识别 → Windows/Linux/具体发行版
   ↓
配置检查 → SSH/防火墙/RDP等
   ↓
日志分析 → 解析auth.log/secure/Security
   ↓
威胁识别 → 统计失败次数，识别可疑IP
   ↓
自动封禁 → UFW/iptables/Windows Firewall
   ↓
生成报告 → JSON格式
   ↓
CLI显示 → 格式化输出
   ↓
AI分析 → 专业建议
   ↓
用户查看
```

---

## 🎨 显示样式

### 严重级别图标

- 🔴 **高危** (High) - 需要立即处理
- 🟡 **中危** (Medium) - 应尽快处理
- 🔵 **低危** (Low) - 建议处理

### 功能图标

- 🔒 安全审计
- ⚠️ 配置问题
- 🚨 攻击检测
- 🛡️ 自动封禁
- 💡 安全建议
- 📊 统计信息

---

## 📈 未来增强

### 短期（已规划）
- [ ] 支持更多服务日志分析（Nginx、Apache）
- [ ] IP白名单功能
- [ ] 邮件/钉钉告警
- [ ] 封禁规则自定义

### 中期（考虑中）
- [ ] Web界面查看审计报告
- [ ] 历史记录和趋势分析
- [ ] 自动修复脚本生成
- [ ] 合规性检查（CIS Benchmark）

### 长期（愿景）
- [ ] 机器学习异常检测
- [ ] 0day攻击识别
- [ ] 自适应防护策略
- [ ] 集成SIEM系统

---

## 🛠️ 故障排查

### 问题1: 无法读取日志文件

**错误**: Permission denied

**解决**: 
```bash
# 以sudo运行
sudo npm start

# 或添加用户到adm组
sudo usermod -a -G adm $USER
```

### 问题2: UFW命令失败

**错误**: ufw command not found

**解决**:
```bash
# Ubuntu/Debian安装
sudo apt install ufw

# 或使用iptables模式（自动fallback）
```

### 问题3: Windows防火墙规则添加失败

**错误**: Access denied

**解决**: 以管理员身份运行PowerShell

---

## 📚 相关文档

- [YunSeeAI项目规划文档](../YunSeeAI 项目规划文档.md)
- [语义理解系统说明](语义理解系统说明.md)
- [WAF识别集成说明](WAF识别集成说明.md)
- [YunSeeAI功能总览](YunSeeAI功能总览.md)

---

## 🙏 致谢

感谢用户提出安全运维模块的需求！

本模块实现了：
- ✅ 智能系统识别
- ✅ 配置安全审计
- ✅ 日志分析与攻击检测
- ✅ 自动封禁攻击IP
- ✅ 纯英文代码，高兼容性
- ✅ Windows + Linux全平台支持

---

**YunSeeAI v2.0.0**  
智能安全运维，自动防护升级 🔒🛡️

**核心优势：**
- 🖥️ 跨平台支持（Windows/Linux）
- 🔍 深度配置审计
- 🚨 实时攻击检测
- 🛡️ 自动防御封禁
- 💡 AI智能分析
- 🌐 自然语言交互

**让安全运维变得简单智能！** 🚀



