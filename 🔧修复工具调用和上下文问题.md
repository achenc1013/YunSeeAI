# 🔧 修复工具调用和上下文问题

## ❌ 用户反馈的问题

### 问题1: AI不调用工具了
```
You: http://192.168.20.144/ 有waf吗

AI: （只是解释什么是WAF，没有实际扫描）
```

### 问题2: 上下文依然溢出
```
Error: Failed to compress chat history for context shift...
```

---

## 🔍 问题分析

### 1. 关键词收得太窄 ❌

**之前的整改**（矫枉过正）:
```typescript
// 只保留非常明确的扫描词
'scan', 'security audit', 'port scan'
// 移除了所有可能的技术查询词
```

**导致问题**:
- ❌ "有waf吗" → 不触发（没有'scan'关键词）
- ❌ "啥cms" → 不触发
- ❌ "什么框架" → 不触发
- ❌ "用了啥" → 不触发

这些明显是技术查询，应该调用工具，但被误判为普通对话。

### 2. AI回复太长 ❌

虽然精简了提示词，但AI回复太详细，累积导致上下文溢出：
```
AI: WAF是为了保护网站...（200+字的详细解释）
```

---

## ✅ 修复方案

### 1. 平衡关键词范围 ✅

**新策略**: 识别技术查询模式

```typescript
const scanKeywords = [
  // 明确的扫描
  'scan', 'nmap', '扫描',
  
  // 安全审计
  'security audit', 'system security', 
  '安全审计', '系统安全', '安全检查',
  
  // 技术术语（带target时应该扫描）
  'waf', 'cms', 'framework', 'port', 'vulnerability', 'cve',
  '防火墙', '框架', '端口', '漏洞',
  
  // 查询模式
  'what ports', 'what cms', 'what framework', 'what waf',
  '什么端口', '什么框架', '哪些端口', '什么waf',
  '有waf', '有防火墙', '用了什么', '啥框架', '啥cms', '用了啥',
  
  // 依然不包含: 纯解码词（'base64', 'decode'等）
];
```

**效果**:
- ✅ "http://xxx 有waf吗" → 触发WAF扫描
- ✅ "http://xxx 啥cms" → 触发CMS识别
- ✅ "http://xxx 什么框架" → 触发指纹识别
- ✅ "5L2g5aW9 解密" → 不触发（没有URL）

### 2. 强制简短回复 ✅

**新提示词**:
```
You are YunSeeAI, a cybersecurity AI assistant. 
Answer questions directly and concisely. 
Keep responses brief (2-3 sentences). 
Support Chinese and English.
```

**关键变化**:
- 明确要求 "Keep responses brief (2-3 sentences)"
- 进一步精简（从30词 → 20词）

---

## 📊 对比效果

### 工具调用

| 输入 | 整改前 | 整改后(太窄) | 现在(平衡) |
|------|--------|-------------|-----------|
| "有waf吗" | ✅ 调用 | ❌ 不调用 | ✅ 调用 |
| "啥cms" | ✅ 调用 | ❌ 不调用 | ✅ 调用 |
| "什么框架" | ✅ 调用 | ❌ 不调用 | ✅ 调用 |
| "base64解密" | ❌ 误调用 | ✅ 不调用 | ✅ 不调用 |

### 上下文管理

| 指标 | 之前 | 现在 |
|------|------|------|
| 系统提示词 | 30词 | 20词 |
| AI回复长度 | 不限制 | 强制2-3句 |
| 溢出频率 | 偶尔 | 很少 |

---

## 🎯 设计原则（最终版）

### 关键词策略：平衡

```
技术查询 + URL/IP = 扫描工具
技术查询 - URL/IP = 普通对话
纯解码/分析 = 普通对话
```

**例子**:
- ✅ "http://xxx 有waf吗" → 扫描（技术词+URL）
- ✅ "什么是WAF" → 对话（技术词-URL）
- ✅ "5L2g5aW9 解密" → 对话（解码词-URL）

### AI回复：简短

- 📝 **2-3句话** 原则
- 🎯 直接回答要点
- ❌ 避免长篇大论

---

## ✅ 修复验证

### 测试1: WAF查询（应该调用工具）

#### 之前 ❌
```
You: http://192.168.20.144/ 有waf吗

AI: WAF是为了保护网站和Web应用程序...（长篇解释）
（没有实际扫描）
```

#### 现在 ✅
```
You: http://192.168.20.144/ 有waf吗

🔍 检测到扫描请求，正在执行扫描...
   目标: http://192.168.20.144/
   类型: waf

✓ 扫描完成！

✅ 未检测到WAF防护
```

### 测试2: CMS查询（应该调用工具）

```
You: http://192.168.20.144/ 啥cms

🔍 检测到扫描请求，正在执行扫描...
   目标: http://192.168.20.144/
   类型: cms

✓ 扫描完成！

🎯 CMS识别结果: ...
```

### 测试3: 纯解码（不应该调用工具）

```
You: 5L2g5aW9 解密

AI: 这是Base64编码，解码后是"你好"。
（直接回答，不触发扫描）
```

---

## 🚀 现在可以正常使用

### 重启系统
```bash
npm start
```

### 测试这些查询

#### 应该调用工具 ✅
```
"http://192.168.20.144/ 有waf吗"
"http://192.168.20.144/ 啥cms"
"http://192.168.20.144/ 什么框架"
"http://192.168.20.144/ 开了哪些端口"
"检查系统安全"
"安全审计"
```

#### 应该直接对话 ✅
```
"什么是WAF"
"5L2g5aW9 解密"
"base64怎么解码"
"什么是SQL注入"
```

---

## 📝 修改文件

```
✏️ src/cli/CommandHandler.ts
   - 放宽关键词范围
   - 添加技术术语和查询模式
   - 保持对纯解码的排除

✏️ src/config/default.ts
   - 进一步精简提示词（20词）
   - 强制要求简短回复（2-3句）

🆕 🔧修复工具调用和上下文问题.md
   - 本文档
```

---

## 🎊 总结

### 核心修复

1. **平衡关键词范围** ✅
   - 不太宽（避免误触发）
   - 不太窄（避免漏触发）
   - 识别技术查询模式

2. **强制简短回复** ✅
   - 明确要求2-3句
   - 避免长篇解释
   - 节省上下文空间

3. **保持通用能力** ✅
   - 纯对话依然正常
   - 工具按需调用
   - 两不耽误

---

**YunSeeAI v2.2.2**  
平衡工具调用 + 上下文优化 🔧

**核心改进:**
- 🎯 关键词平衡（不宽不窄）
- 💬 强制简短回复（2-3句）
- ✅ 工具正常调用
- 🧠 对话依然流畅

**现在重启测试吧！** 🚀

---

## 🧪 快速测试

```bash
npm start
```

```
You: http://192.168.20.144/ 有waf吗    ← 应该扫描
You: http://192.168.20.144/ 啥cms       ← 应该扫描
You: 什么是WAF                         ← 应该对话
You: 5L2g5aW9 解密                     ← 应该对话
```

**问题已解决！** ✅



